 ;??????????????????????????????????????????????????????????
 ;??                                                      ??
 ;??         ???????????????????????????????????          ??
 ;??         ? ? ? ? ? ? ? ? ? ?   L O C K E R ?          ??
 ;??         ???????????????????????????????????          ??
 ;??                                                      ??
 ;?? ??? ??????? ? ????? ??  COM ??? , "? ?? ?? ?"    ??
 ;?? ?????  ?? ?? ????. ????? ??   ?????? ??? ??  ?????  ??
 ;?? ?????? ? Int09 ? ? ?? ?? ? ???????? 5232 ? ??.   ??
 ;??                                                      ??
 ;??????????????????????????????????????????????????????????


 PROGRAM   segment
           assume CS:PROGRAM
           org   100h         ;??????? PSP ??? COM-????? ???

 Start:    jmp   InitProc     ;???????   ??? ??? ??


 ;????????? ? ? ? ? ? ? ? ? ? ? ?   ? ? ? ? ? ? ????????????

 FuncNum   equ   0EEh           ;??????????? ? ???? ???-
                                ;??? ? BIOS Int16h
 CodeOut   equ   2D0Ch          ;???,????? ? ????  ??? ??-
                                ;? ???????? Int16h
 TestInt09 equ   9D0Ah          ;????? ????? Int09h
 TestInt16 equ   3AFAh          ;????? ????? Int16h

 OldInt09  label dword          ;???? ??? ????? Int09h:
  OfsInt09 dw    ?              ;   ??? ???????
  SegInt09 dw    ?              ;   ? ??????

 OldInt16  label dword          ;???? ??? ????? Int16h:
  OfsInt16 dw    ?              ;   ??? ???????
  SegInt16 dw    ?              ;   ? ??????

 OK_Text   db    0              ;???? ? ? ??? ??  
 Sign      db    ?              ;??????????  ? ??? Ctrl
 VideoLen  equ   800h           ;???  ?????????? 

 VideoBuf  db    160 dup(' ')
 db  13 dup(' ')
 db '??????????????????????????????????????????????????????'
 db  26 dup(' ')
 db '?                                                    ?'
 db  26 dup(' ')
 db '?   ??? ? ??????????  ???? ??? ? ?  VOVA   ?'
 db  26 dup(' ')
 db '?                                                    ?'
 db  26 dup(' ')
 db '?                                                    ?'
 db  26 dup(' ')
 db '??????????????????????????????????????????????????????'
 db  2000 dup(' ')

 AttrBuf   db    VideoLen dup(07h)  ; ??????? ??  
 VideoBeg  dw    0B800h         ; ????  ? ?  ???????? ???
 VideoOffs dw    ?              ;???????  ????? ??? ?
 CurSize   dw    ?              ;???? ??? ? ???? ???? 

 ;?????? ? ? ? ? ? ? ? ? ? ? ?   ? ? ? ? ? ? ? ? ? ?????????

 ;
 ;???????????? ?????? ???????????? ? ??????? ?????????

 VideoXcg proc
     lea   DI,VideoBuf   ;? DI -  ???? ?????  ????????
     lea   SI,AttrBuf    ;? SI -  ???? ?????   ????????

     mov   AX,VideoBeg   ;?? ES - ????????  ????
     mov   ES,AX         ;? ? ?  ???????? ???

     mov   CX,VideoLen   ;? CX - ???  ?????????? 
     mov   BX,VideoOffs  ;? BX -  ?. ??????? ??????

   Draw:
     mov   AX,ES:[BX]    ;???????? ??????/ ??????  
     xchg  AH,DS:[SI]    ;??? ? ? ???????? ?  ?????-
     xchg  AL,DS:[DI]    ;???? ?? ???????
     mov   ES:[BX],AX    ;?

     inc   SI            ;???????  ????
     inc   DI            ;?? ????? ?

     inc   BX            ;???????  ????
     inc   BX            ;?? ???????????

     loop  Draw          ;???? ?? ??? ???? ???????? ???
     ret                 ;????? ?
 VideoXcg endp

 ;
 ;?????????? ?????????? Int09h (?????????? ?? ??????????)

     dw    TestInt09     ;????? ??? ?? ????? ?????? ? 

 Int09Hand proc
 .386
     push  AX            ;?
     push  BX            ;?
     push  CX            ;????? ?
     push  DI            ;????????????
     push  SI            ;???????
     push  DS            ;?
     push  ES            ;?

     push  CS            ;??? ? ?? DS  
     pop   DS            ;? ?? ????? ???

     in    AL,60h        ;?????? ??  ???  ? ??? ?? ???

     cmp   AL,2Dh        ;????????   ?? -??? ?? ???
     jne   Exit_09       ;?<L> ? ?????, ???? ? ?

     xor   AX,AX         ;?
     mov   ES,AX         ;???????? ?? ?? ?? ?? ????  
     mov   AL,ES:[417h]  ;? ? ??? <Ctrl+Alt>
     and   AL,00001010b        ;?
     cmp   AL,00001010b        ;?
     je    Cont          ;?

   Exit_09:
     jmp   Exit09        ;?????

   Cont:


     sti                 ;? ????? ?????? ?

     mov   AH,0Fh        ;??????? ?????
     int   10h           ;???????????
     cmp   AL,2          ;?
     je    InText        ;????????   InText
     cmp   AL,3          ;????? ?????
     je    InText        ;???????? 80#25
     cmp   AL,7          ;?
     je    InText        ;?

     jmp   short SwLoop1 ;? ?? - ????????

  InText:
     xor   AX,AX         ;???? ??? ????????
     mov   ES,AX         ;? ???? ? 0000h

     mov   AX,ES:[44Eh]  ;??????? ???????  ?????
     mov   VideoOffs,AX  ;???? ? ? VideoOffs

     mov   AX,ES:[44Ch]  ;??? ?? ??? ?????????? 
     cmp   AX,1000h      ;?? 1000h.???? ? ? ??,
     jne   Exit009       ;??? ????? EGA Lines
                         ;?(??  ???? ?  ??)
     mov   AH,03h        ;?? ?? ???? ?
     int   10h           ;?? ???? ???? 
     mov   CurSize,CX    ;?? CurSize

     mov   AH,01h        ;?
     mov   CH,20h        ;?? ??? ?? ???
     int   10h           ;?

     mov   OK_Text,01h   ;??? ??? ???? ? ? ???
                         ;??  
     call  VideoXcg      ;? ???? ?? ????????? ? ???

  SWLoop1:
    in al, 60h
    cmp al, 2Fh
    je SWLoop11
    jne SWLoop1

  SWLoop11:
    in al,60h 
    cmp al, 0AFh 
    je SWLoop2
    jmp SWLoop11

  SWLoop2: 
    in al, 60h
    cmp al, 18h
    je SWLoop21
    cmp al, 0AFh
    je SWLoop2 
    jne SWLoop1

  SWLoop21: 
    in al,60h 
    cmp al, 98h 
    je SWLoop3
    jmp SWLoop21

  SWLoop3: 
    in al, 60h
    cmp al, 2Fh
    je SWLoop31
    cmp al, 98h
    je SWLoop3 
    jne SWLoop1

  SWLoop31: 
    in al,60h 
    cmp al, 0AFh 
    je SWLoop4
    jmp SWLoop31

  SWLoop4: 
    in al, 60h
    cmp al, 1Eh
    je SWLoop41
    cmp al, 0AFh
    je SWLoop4 
    jne SWLoop1

  SWLoop41: 
    in al,60h 
    cmp al, 9Eh 
    je Exit 
    jmp SWLoop41
  
Exit:
     mov   Sign,0        ;?????? ???-??  ? ???   Ctrl

     cmp   OK_Text,01h   ;????? ??  ? ??? ???????,
     jne   Exit009       ;??? ?????

     call  VideoXcg      ;? ?? ?????? ?? 

     mov   AH,01h        ;?
     mov   CX,CurSize    ;?????? ??? ????
     int   10h           ;?

     mov   OK_Text,0h    ;?????? ???? ? ? ??? ??  

   Exit009:
     xor   AX,AX         ;?
     mov   ES,AX         ;????? ?? ??  ? ??
     mov   AL,ES:[417h]  ;?<Control+Alt> ??  ?????
     and   AL,11110101b  ;?0000h:0417h ? ?? ??
     mov   ES:[417h],AL  ;?<LeftControl+LeftAlt>
     mov   AL,ES:[418h]  ;???  ????? 0000h:0418h
     and   AL,11111110b  ;?
     mov   ES:[418h],AL  ;?

     mov   AL,20h        ;???????? ?????????
     out   20h,AL        ;??????? ??

     cli                 ;? ????? ?????? ?
     pop   ES            ;?
     pop   DS            ;?
     pop   SI            ;?????? ???
     pop   DI            ;????????????
     pop   CX            ;???????
     pop   BX            ;?
     pop   AX            ;?
     iret                ;????? ?? ?????? ?

   Exit09:
     cli                 ;? ????? ?????? ?
     pop   ES            ;?
     pop   DS            ;?
     pop   SI            ;?????? ???
     pop   DI            ;????????????
     pop   CX            ;???????
     pop   BX            ;?
     pop   AX            ;?
     jmp   CS:OldInt09   ;?;????? ?? ??? ????? "?? ???????"
                         ;?;?????????? ??? ?????? Int09h
 Int09Hand endp

 ;
 ;?????????? ?????????? Int16h (????? ??????? BIOS)

     dw    TestInt16     ;????? ??? ?? ????? ?????? ? 

 Presense proc
     cmp   AH,FuncNum    ;??? ???? ??  ??? ????? ????
     jne   Pass          ;???? ?? ?? ???? ? ??? ??
     mov   AX,CodeOut    ;? ?? ? AX ????????? ???
     iret                ;? ????? ????

   Pass:
     jmp   CS:OldInt16   ;????? ?? ??? ????? "?? ???????"
                         ;?????????? ??? ?????? Int16h
 Presense endp


 ;???????? ? ? ? ? ? ? ? ? ? ? ? ? ?   ? ? ? ? ? ? ?????????

 ResEnd      db    ?    ;? ?? ??? ????????? ?? ? ??-
                        ;??????? ? ??? ????? ???
 On          equ   1    ;? ???? "??? ????" ???  ?? ???
 Off         equ   0    ;? ???? "??????" ??? ?? ???
 Bell        equ   7    ;??? ??????  BELL
 CR          equ   13   ;??? ??????  CR
 LF          equ   10   ;??? ??????  LF
 MinDosVer   equ   2    ;???? ?? ? ?????? ? ????? DOS

 InstFlag    db    ?    ;?? ?  ??? ????? ??? ? ? ????
 SaveCS      dw    ?    ;???? ??? CS ????????? ????-
                        ;? ???

 Copyright   db CR,LF,' L O C K E R  ??????? ??? ? ???'
             db '?? ?? ',CR,LF,LF,'$'
 VerDosMsg   db '????? : ??????? ? ????? DOS'
             db Bell,CR,LF,'$'
 InstMsg     db '????? ??  LOCKER ??? ???? .??? ???? ?'
             db '????????? ???? /u',CR,LF
             db '??? "? ?? ?"  ???? <Shift+lAlt+X>',CR,LF
             db '??? "???? ?" ??????  ???? <VOVA>'
             db CR,LF,'$'
 AlreadyMsg  db '????? : LOCKER ??? ???????  ? ? ????'
             db Bell,CR,LF,'$'
 UninstMsg   db '????? ??  LOCKER ???  ? ??????? '
             db CR,LF,'$'
 NotInstMsg  db '????? : ????? ??  LOCKER ? ??? ???? '
             db Bell,CR,LF,'$'
 NotSafeMsg  db '????? : ???? ? ???????  ????? ??? LOCKER'
             db ' ? ? ?? ?????',CR,LF,'???????? ??-?  '
             db '?????? ?  ???????? ???????',Bell,CR,LF,'$'


 ;?????? ? ? ? ? ? ? ? ? ? ? ? ? ?   ? ? ? ? ? ? ? ? ? ?????

 ;
 ;?????????? ???? ??? ?????????? ????????? ?????? ??????????

 Locker      equ   0      ;??? ??? ??????? ??? ?p??p ???
                          ;?? ????? ???? ? ???
 include     INFO.INC     ;????? ???? ? ?? ? ?????????? ??-
                          ;???  ???? ???

 ;
 ;??????? ????????? ?????????????

 InitProc proc
     mov   AH,09h          ;?
     lea   DX,Copyright    ;????????  ? ???? ????????
     int   21h             ;?

     lea   DX,VerDosMsg    ;???????? ????? DOS ? ??-
     call  ChkDosVer       ;?????? ????????,???? ????-
     jc    Output          ;?????? ?

     call  PresentTest     ;???????  ???? ? ? ????

     mov   BL,DS:[5Dh]     ;?
     and   BL,11011111b    ;?
     cmp   BL,'I'          ;?? ???? ?? ???? (? ????
     je    Install         ;?? ??? ??? FCB1 PSP)
     cmp   BL,'U'          ;?
     je    Uninst          ;?

     call  @InfoAbout      ;??????? ???? ??
     jmp   short ToDos     ;? ???????? ? DOS
                           ;???? ???? ? ???
   Install:
     lea   DX,AlreadyMsg
     cmp   InstFlag,On     ;????? ??? ??? ???? ,??
     je    Output          ;????????   ????? ???????

     xor   AX,AX           ;?? ?? ??????  ? ??
     mov   ES,AX           ;????????? ??? : ???? ? ? ??? ??
     mov   AL,ES:[411h]    ;? ????? 0000h:0411h ??? ????
     and   AL,30h          ;?3-? ??,?? ????????  ????  -
     cmp   AL,30h          ;?? ?  ???????? ??? 0B000h ? ??
     jne   Vid1            ;?????????  ???? ? ?? 0B800h
     mov   VideoBeg,0B000h ;?

   Vid1:
     call  GrabIntVec      ;? ?? ?? ???? ????? 

     mov   AX,DS:[2Ch]     ;????????? ??????,??????-
     mov   ES,AX           ;??? ????? ??? ??? ???????
     mov   AH,49h          ;?? ?? ???? ? ???????? ? ????
     int   21h             ;?

     mov   AH,09h          ;???????? ???????? ?? ??? ????
     lea   DX,InstMsg      ;?? ???????
     int   21h             ;?

     lea   DX,ResEnd       ;?? ????? ? ??? ?? ????? ?-
     int   27h             ;??? ? ????????

   Uninst:
     lea   DX,NotInstMsg   ;????? ????? ??  ? ??? ???? ,
     cmp   InstFlag,Off    ;??? ??????? ???????? ?? ????
     je    Output          ;?

     lea   DX,NotSafeMsg   ;????? ????? ??? ????????
     call  TestIntVec      ;????? ? ??????? ,?? ???????
     jc    Output          ;????????? ?? ????

     call  FreeIntVec      ;???????? ?????  ?????? ??

     mov   AH,49h          ;????????? ? ????,? ?? ????
     mov   ES,SaveCS       ;?????????? ? ???? ????? ???
     int   21h             ;?

     lea   DX,UninstMsg

   Output:
     mov   AH,09h          ;???????? ???? ????????
     int   21h             ;?

   ToDos:
     mov   AX,4C00h        ;????????? ? DOS ? ?????
     int   21h             ;?? ?????? 0
     ret                   ;????? ?
 InitProc endp

 ;
 ;????????? ???????? ?????? DOS
 ;????? ? ?? ??? ?????? ?? ? ?????? ,????
 ;????? DOS ????? ? ? ?? ? MinDosVer

 ChkDosVer proc
     mov   AH,30h         ;??????? ? AX ???? ??????
     int   21h            ;?DOS
     cmp   AL,MinDosVer   ;?? ?? ?? ? ???? ????

     clc                  ;?????? ?? ? ??????  (CF)
     jge   Norma          ;???? ????? ???????? ?
     stc                  ;? ?? ??? ??? ?? ? ?????? 

   Norma:
     ret                  ;????? ?
 ChkDosVer endp

 ;
 ;????????? ??????????? ??????? ????????? ? ??????

 PresentTest proc
     mov   InstFlag,Off   ;?????? ?? ?  ??? ? ????????
     mov   AH,FuncNum     ;???? ???? ?  ???? ????????
     int   16h            ;?
     cmp   AX,CodeOut     ;???????? ??????
     jne   Return         ;???? ??,?? ????
     mov   InstFlag,On    ;? ?? ??? ??? ?? ?  ???
   Return:
     ret                  ;????? ?
 PresentTest endp

 ;
 ;????????? ??????? ???????? ??????????

 GrabIntVec proc
     mov   AX,3509h       ;????? ? ?? ?????? ????-
     int   21h            ;????? ?? ??? ????? ?????? -
     mov   OfsInt09,BX    ;?? Int09h
     mov   SegInt09,ES    ;?

     mov   AX,3516h       ;????? ? ?? ?????? ????-
     int   21h            ;????? ?? ??? ????? ?????? -
     mov   OfsInt16,BX    ;?? Int16h
     mov   SegInt16,ES    ;?

     mov   AX,2509h       ;???? ??? Int09Hand ? ? ??????
     lea   DX,Int09Hand   ;?????? ??? ??????  ?????? ?
     int   21h            ;?Int09

     mov   AX,2516h       ;???? ??? Presense ? ? ??????
     lea   DX,Presense    ;?????? ??? ??????  ?????? ?
     int   21h            ;?Int16h
     ret
 GrabIntVec endp

 ;
 ;????????? ???????? ????????? ???????? ??????????
 ;????? ? ?? ??? ?????? ?? ? ??????  ? ???? ? ?????? ? 
 ;???? ?? ????? ?????  ?????? ?

 TestIntVec proc
     mov   AX,3509h            ;????????, ????? ?? ??-
     int   21h                 ;?????? ????? ????? ??? ???-
     cmp   ES:[BX-2],TestInt09 ;?????? ?????? ? Int09
     stc                       ;??? ??? ?? ? ??????  CF,
     jne   Cant                ;???? ?????? ?? ?????? ????

     mov   AX,3516h            ;????????, ????? ?? ??-
     int   21h                 ;?????? ????? ????? ??? ???-
     cmp   ES:[BX-2],TestInt16 ;?????? ?????? ? Int16h
     stc                       ;??? ??? ?? ? ??????  CF,
     jne   Cant                ;???? ?????? ?? ?????? ????

     mov   SaveCS,ES           ;? ???? CS ?????????
     clc                       ;????? ???,?????? ?? ?
                               ;?????? 
   Cant:
     ret                       ;????? ?
 TestIntVec endp

 ;
 ;????????? ?????????????? ??????????? ???????? ??????????

 FreeIntVec proc
     push  DS             ;???? ? DS

     mov   AX,2509h       ;?????? ??? ????? ?????? ?
     mov   DS,ES:SegInt09 ;?Int09h ?? ?????? ????????
     mov   DX,ES:OfsInt09 ;?????????? ????? ???
     int   21h            ;?

     mov   AX,2516h       ;?????? ??? ????? ?????? ?
     mov   DS,ES:SegInt16 ;?Int16h ?? ?????? ????????
     mov   DX,ES:OfsInt16 ;?????????? ????? ???
     int   21h            ;?

     pop   DS             ;????? ??? DS
     ret                  ;????? ?
 FreeIntVec endp

 PROGRAM   ends
           end   Start
